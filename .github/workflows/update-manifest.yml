name: Protect manifest.json

on:
  pull_request:
    branches: [ main ]
    paths: [ "manifest.json" ]
  push:
    branches: [ main ]
    paths: [ "manifest.json" ]

jobs:
  # Block PRs that edit manifest.json
  block_pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Fail if manifest.json is edited
        run: |
          echo "‚ùå manifest.json cannot be edited manually. It is auto-generated."
          exit 1

  # If someone pushes to main and changed manifest.json, auto-correct it
  autocorrect_push:
    if: github.event_name == 'push' && github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Rebuild manifest.json from dated JSONs
        run: |
          python - <<'EOF'
          import json, os
          files = sorted(f for f in os.listdir('.') if f.endswith('.json') and f != 'manifest.json')
          latest = max((f[:-5] for f in files), default=None)
          with open('manifest.json','w') as fp:
            json.dump({"latestVersion": latest, "files": files}, fp, indent=2)
          print("Rebuilt manifest. Files:", len(files), "Latest:", latest)
          EOF

      - name: Commit corrected manifest
        run: |
          if [[ -n "$(git status --porcelain manifest.json)" ]]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add manifest.json
            git commit -m "auto-correct manifest (manual edit reverted)"
            git push
          else
            echo "Manifest already correct."
          fi
